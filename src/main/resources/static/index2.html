<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>流程管理</title>
<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery-form.js"></script>
<script type="text/javascript">
	var t = new Date(); 
	var y = t.getFullYear();
	var m = t.getMonth()+1;
	if(m<10){
		m = "0"+m;
	}
	var date = y+""+m;
	var classId = date;
	function selectOpt(){
	    //var ads = self.parent.frames['rightFrame'].address;
		classId = $("#classId").find("option:selected").val();
		taskShow();
	}
	function taskShow(){
		var url = "hwtraining-teacher-service/hwtraining/v1/tasks";
		$.ajax({
			type : "GET",
			url : url,
			dataType : "json",
			cache : false,
			async : false,
			data : {classId: classId},
			success : function(data) {
				var s = '<table  class="tablelist" ><tr><th>班次</th><th>状态</th><th>截止时间</th><th>责任人</th><th>角色</th><th>任务</th><th>任务详情</th><th>备注</th></tr>';
				var jsonReturn = eval(data);
				for (var i = 0; i < jsonReturn.length; i++) {
					s += '<tr id="'+i+'"><td >'
							+ jsonReturn[i].classId
							+ '</td><td><input  type="button" value="'
							+ jsonReturn[i].status
							+ '" onclick="changeStatus('
							+ i
							+ ')"/></td><td>'
							+ jsonReturn[i].deadline
							+ '</td><td>'
							+ jsonReturn[i].handPeople
							+ '</td><td>'
							+ jsonReturn[i].role
							+ '</td><td>'
							+ jsonReturn[i].task
							+ '</td><td>'
							+ jsonReturn[i].detail
							+ '</td><td><textarea rows="3" cols="20">'
							+ jsonReturn[i].comment
							+ '</textarea></td></tr>';
				}
				s += '</table><input type="hidden" id="taskslist" value="'+jsonReturn.length+'">'
				$('#dv').html(s);
			},
			error : function(data) {
				alert("Error!!!");
			}
		});
		var taskslist = $("#taskslist").val();
		for (var j = 0; j < taskslist; j++) {
			var btn = $(
					"#"
							+ j
							+ " td:nth-child input[type='button'] ")
					.val();
			if (btn == "1") {
				$(
						"#"
								+ j
								+ " td:nth-child input[type='button'] ")
						.val("已完成");
				$(
						"#"
								+ j
								+ " td:nth-child input[type='button'] ")
						.attr("disabled", "disabled");
				$("#" + j + " td:nth-child textarea").attr(
						"disabled", "disabled");
			} else {
				$(
						"#"
								+ j
								+ " td:nth-child input[type='button'] ")
						.val("未完成");
			}
		}
	}
	function changeStatus(id) {
		classId = $('#' + id + ' td:nth-child(1)').text();
		task = $('#' + id + ' td:nth-child(6)').text();
		handPeople = $('#' + id + ' td:nth-child(4)').text();
		comment = $('#' + id + ' td:nth-child(8) textarea').val();
		url2 = "hwtraining-teacher-service/hwtraining/v1/tasks";
		$.ajax({
			type : "PUT",
			url : url2,
			dataType : "json",
			cache : false,
			async : false,
			data : {
				classId : classId,
				task : task,
				handPeople : handPeople,
				comment : comment
			},
			success : function(data) {
				$("#" + id + " td:nth-child input[type='button'] ").val("已完成");
				$("#" + id + " td:nth-child input[type='button'] ").attr(
						"disabled", "disabled");
				$('#' + id + ' td:nth-child(8)').value = $(
						'#' + id + ' td:nth-child(8)').text();
				$('#' + id + ' td:nth-child(8)').attr("disabled", "disabled");
			},
			error : function(data) {
				alert("Error!!!");
			}
		});
	}
			$(document).ready(function(){
				$("#clickAdd").click(function(){
				    $("#tipAdd").fadeIn(200);
				});
				$("#clickDelete").click(function(){
				    $("#tipDelete").fadeIn(200);
				});
				$(".tiptop a").click(function(){
				    $(".tip").fadeOut(200);
				    $(".tipDelete").fadeOut(200);
				});
			$("#sureAdd").click(function(){
			    $("#tipAdd").fadeOut(100);
			    var companyName=$("#companyName").val();
			    var name=$("#name").val();
			    var title=$("#title").val();
			    var phoneNumber=$("#phoneNumber").val();
			    var email=$("#email").val();
			    var hwcloudId=$("#hwcloudId").val();
			    var comment=$("#comment").val();
			    $.ajax({
			    	type : "POST",
					url : "hwtraining-teacher-service/hwtraining/v1/student",
					contentType: "application/json",
					dataType : "json",
					cache : false,
					async : false,
					data : JSON.stringify({
						"classId": classId,
						"companyName": companyName,
						"name": name,
						"title": title,
						"phoneNumber": phoneNumber,
						"email": email,
						"hwcloudId": hwcloudId,
						"comment": comment
					}),
					success : function(data) {
						if(data == true){
							studentShow();
						}else{
							alert("false!!!");
							return;
						}
					},
					error : function(data) {
						alert("Error!!!");
					}
			        
			    });
			});
			$("#sureDelete").click(function(){
				$("#tipDelete").fadeOut(100);
				obj = document.getElementsByName("student");
			    check_val = [];
			    for(k in obj){
			        if(obj[k].checked)
			            check_val.push(obj[k].value);
			    }
				url2 = "hwtraining-teacher-service/hwtraining/v1/student";
			    for(k in check_val){
			    	n = check_val[k];
					classId = $('#'+n+' td:nth-child(2)').text();
					name = $('#'+n+' td:nth-child(4)').text();
					phoneNumber = $('#'+n+' td:nth-child(6)').text();
					$.ajax({
						type : "DELETE",
						url : url2,
						dataType : "json",
						cache : false,
						async : false,
						data : {
							classId: classId,
							name: name,
							phoneNumber: phoneNumber
						},
						success : function(data) {
							studentShow();
						},
						error : function(data) {
							alert("Error!!!");
							return;
						}
					});
			    }
			});
			$(".cancel").click(function(){
			    $(".tip").fadeOut(100);
			    $(".tipDelete").fadeOut(100);
			});
			});
	function studentShow(){
		
		url = "hwtraining-teacher-service/hwtraining/v1/students";
		$.ajax({
			type : "GET",
			url : url,
			contentType: "application/json",
			dataType : "json",
			cache : false,
			async : false,
			data : {classId: classId},
			success : function(data) {
				var s = '<table  class="tablelist" ><tr><th><input type="checkbox"></th><th>班次</th><th>公司</th><th>姓名</th><th>岗位</th><th>手机号</th><th>邮箱</th><th>公有云账户</th><th>备注</th></tr>';
				var jsonReturn = eval(data);
				for (var i = 0; i < jsonReturn.length; i++) {
					s += '<tr id="'+i+'"><td><input name="student" type="checkbox" value="'+i+'"/><td >' + jsonReturn[i].classId + '</td><td>' + jsonReturn[i].companyName + '</td><td>' + jsonReturn[i].name + '</td><td>' + jsonReturn[i].title + '</td><td>'+jsonReturn[i].phoneNumber+'</td><td>'+jsonReturn[i].email+'</td><td>'+jsonReturn[i].hwcloudId+'</td><td><textarea disabled="disabled" rows="3" cols="20">'+jsonReturn[i].comment+'</textarea></td></tr>';
				}
					s += '</table><input type="hidden" id="taskslist" value="'+jsonReturn.length+'">'
					$('#dv').html(s);
			},
			error : function(data) {
				alert("Error!!!");
			}
		});
	}
	function scoreShow(){
		url = "hwtraining-teacher-service/hwtraining/v1/studentscore";
		
		
			cid = classId;
			$.ajax({
				type : "GET",
				url : url,
				dataType : "json",
				cache : false,
				sync : false,
				data : {
					classId : cid
				},
				success : function(data) {
					var s = '<table  class="tablelist" ><tr><th>班次</th><th>姓名</th><th>遗留应用</th><th>中间件</th><th>容器</th><th>微服务</th><th>航空订票</th><th>车联网</th><th>银行理财</th><th>EI视觉</th><th>签到</th><th>总分</th></tr>';
					var jsonReturn = eval(data);
					for (var i = 0; i < jsonReturn.length; i++) {
						total = parseInt(jsonReturn[i].subject1)+parseInt(jsonReturn[i].subject2)+parseInt(jsonReturn[i].subject3)+parseInt(jsonReturn[i].subject4)
								+parseInt(jsonReturn[i].subject5)+parseInt(jsonReturn[i].subject6)+parseInt(jsonReturn[i].subject7)+parseInt(jsonReturn[i].subject8)
								+parseInt(jsonReturn[i].subject9);
						var color="background-color:blue";
						if(total<100){
							color="background-color:red";
						}else{
							color="background-color:blue";												
						}
						s += '<tr><td >'
								+ jsonReturn[i].classId
								+ '</td><td>'
								+ jsonReturn[i].name
								+ '</td><td  ondblclick="changeScoreStatus(this)" ><input  type="text" class="score" value="'
								+ jsonReturn[i].subject1
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td ondblclick="changeScoreStatus(this)"><input type="text" class="score" value="'
								+ jsonReturn[i].subject2
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td ondblclick="changeScoreStatus(this)"><input type="text" class="score" value="'
								+ jsonReturn[i].subject3
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td ondblclick="changeScoreStatus(this)"><input type="text" class="score" value="'
								+ jsonReturn[i].subject4
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td ondblclick="changeScoreStatus(this)"><input type="text" class="score" value="'
								+ jsonReturn[i].subject5
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td ondblclick="changeScoreStatus(this)"><input type="text" class="score" value="'
								+ jsonReturn[i].subject6
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td ondblclick="changeScoreStatus(this)"><input type="text" class="score" value="'
								+ jsonReturn[i].subject7
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td ondblclick="changeScoreStatus(this)"><input type="text" class="score" value="'
								+ jsonReturn[i].subject8
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td ondblclick="changeScoreStatus(this)"><input type="text" class="score" value="'
								+ jsonReturn[i].subject9
								+ '"  onblur="modifyScore(this)" disabled="" /></td><td> <input type="text" class="score" style="'+color+'" disabled="disabled" value="'+total+'"/></td></tr>';
								
					}
					s += '</table><input type="hidden" id="taskslist" value="'+jsonReturn.length+'">'
					$('#dv').html(s);
				},
				error : function(data) {
					alert("Error!!!");
				}
			});
	}
	function modifyScore(id) {
		var tr = $(id).parent().parent().children();
		classId = $(tr[0]).text();
		name = $(tr[1]).text();
		subject1 = $(tr[2]).children("input").attr('value');
		subject2 = $(tr[3]).children("input").attr('value');
		subject3 = $(tr[4]).children("input").attr('value');
		subject4 = $(tr[5]).children("input").attr('value');
		subject5 = $(tr[6]).children("input").attr('value');
		subject6 = $(tr[7]).children("input").attr('value');
		subject7 = $(tr[8]).children("input").attr('value');
		subject8 = $(tr[9]).children("input").attr('value');
		subject9 = $(tr[10]).children("input").attr('value');
		total = parseInt(subject1)+parseInt(subject2)+parseInt(subject3)
		        +parseInt(subject4)+parseInt(subject5)+parseInt(subject6)
		        +parseInt(subject7)+parseInt(subject8)+parseInt(subject9);
		if(total<100){
			$(tr[11]).children("input").attr('style',"background-color:red");
		}else{
			$(tr[11]).children("input").attr('style',"background-color:blue");
			
		}
		$(tr[11]).children("input").attr('value',total);
		console.log('subject===>', subject1, subject2, subject3, subject4,
				subject5, subject6, subject7, subject8, subject9)
		$.ajax({
			type : "PUT",
			url : url,
			contentType: "application/json",
			dataType : "json",
			cache : false,
			async : false,
			data : JSON.stringify({
				classId : classId,
				name : name,
				subject1 : subject1,
				subject2 : subject2,
				subject3 : subject3,
				subject4 : subject4,
				subject5 : subject5,
				subject6 : subject6,
				subject7 : subject7,
				subject8 : subject8,
				subject9 : subject9
			}),
			success : function(data) {
				if (data == true) {
					$(id).attr('disabled', 'disabled');
				}

			},
			error : function(data) {
				alert("Error!!!");
			}
		});
	}
	function changeScoreStatus(id) {
		console.log($(id).children("input").text());
		$(id).children("input").attr("disabled", false);
		$(id).children("input").focus();
	}
	function forumShow(){
		var cid = classId;
		//$("#"+date).attr("selected","selected");
		url = "hwtraining-teacher-service/hwtraining/v1/forumcontent";
		$.ajax({
			type : "GET",
			url : url,
			dataType : "json",
			cache : false,
			async : false,
			data : {
				classId : cid
			},
			success : function(data) {
				var s = '<ul id="pn">';
				var jsonReturn = eval(data);
				for (var i = 0; i < jsonReturn.length; i++) {
					s += '<li id="'+i+'" class="list0">'
							+ '<div class="head"><span class="name">班次：'
							+ jsonReturn[i].classId
							+ '</span><span class="name">产品：'
							+ jsonReturn[i].tenant
							+ '</span><span class="name">姓名：'+
							+ jsonReturn[i].name
							+ '</span></div><div class="content"><p class="text">'
							+ jsonReturn[i].content
							+ '</p><div class="pic"><image src="'
							+ jsonReturn[i].path+ '" alt=""/></div><div class="good"><span class="date">'
							+ jsonReturn[i].time
							+ '</span></div>';
				}
				s += '</li></ul><input type="hidden" id="taskslist" value="'+jsonReturn.length+'">'
				$('#dv').html(s);
			},
			error : function(data) {
				alert("Error!!!");
			}
		});
	}
	function uploadPic() {
		// 上传设置  
		var options = {
			url : "hwtraining-teacher-service/hwtraining/v1/upload",
			type : "POST",
			/* contentType : "text/plain", */
			dataType : "text",
			success : function(data) {
				console.log(data);
				$("#allUrl").attr("src", data);
			},
			error : function(data) {
				alert("上传图片失败！！！");
				console.log(data);
				return;
			}
		};

		$("#uploadForm").ajaxSubmit(options);
	}
	function upload() {
		cid = classId;
		var name = $("#name").val();
		var tenant = $("#tenant").val();
		var content = $("#content").val();
		var path = $("#allUrl").attr("src");
		$.ajax({
			url : "hwtraining-teacher-service/hwtraining/v1/forumcontent",
			type : "POST",
			contentType : "application/json",
			dataType : "json",
			cache : false,
			async : false,
			data : JSON.stringify({
				classId : cid,
				name : name,
				tenant : tenant,
				time : "2018-01-30 15:36:45",
				content : content,
				path : path
			}),
			success : function(data) {
				console.log(data);
				window.location.reload();
			},
			error : function(data) {
				alert("保存失败!!!");
				console.log(data);
			}
		});
	}
</script>
</head>
<body>
	<div class="menu">
		<a href="javascript:taskShow();">培训流程管理</a>
		<a href="javascript:studentShow();">学员管理</a>
		<a href="javascript:scoreShow();">成绩管理</a>
		<a href="javascript:forumShow();">问题反馈</a>
		<div class="vocation">
			班次：<select id="classId" onchange="selectOpt()">
				<option id="201802" value="201802">201802</option>
				<option id="201801" value="201801">201801</option>
				<option id="201803" value="201803">201803</option>
				<option id="201804" value="201804">201804</option>
				<option id="201805" value="201805">201805</option>
				<option id="201806" value="201806">201806</option>
				<option id="201807" value="201807">201807</option>
				<option id="201808" value="201808">201808</option>
				<option id="201809" value="201809">201809</option>
				<option id="201810" value="201810">201810</option>
				<option id="201811" value="201811">201811</option>
				<option id="201812" value="201812">201812</option>
			</select>
		</div>
	</div>
	<div>
		<a class="link" href="javascript:showDialog();">登录</a>
	</div>
	<div id="dialog" style="display:none;">
		<div>
			<div>
		    	<input class="ui-dialog-input" type="text" placeholder="手机/邮箱/用户名" value="" />
		  	</div>
		  	<div>
		   		<input class="ui-dialog-input" type="text" placeholder="密码" value="" />
		  	</div>
		  	<div>
		  		<a href="javascript:login();" >登录</a>
		  	</div>
 		</div>
	</div>
		<div class="tools">
			<ul class="toolbar">
				<li class="click" id="clickAdd"><span><img src="images/t01.png" /></span>添加</li>
				<li class="click" id="clickDelete"><span><img src="images/t03.png" /></span>删除</li>
			</ul>
		</div>
		
		<div class="tip" id="tipAdd">
			<div class="tiptop" style="width:785px;">
				<span>信息</span><a></a>
			</div>

			<div class="tipinfo">
				<!-- <span><img src="images/ticon.png" /></span> -->
				<div class="tipright">
					<ul class="forminfo">
						<!-- <li><label><b>* 请仔细核对学员信息，确认无误后提交。</b></label></li> -->
	    				<li><label>公司名称<b>*</b></label><input type="text" class="dfinput" style="width:518px;" id="companyName" /></li>
						<li><label>姓名<b>*</b></label><input type="text" class="dfinput" style="width:518px;" id="name" /></li>
						<li><label>岗位<b>*</b></label><input type="text" class="dfinput" style="width:518px;" id="title" /></li>
						<li><label>手机号<b>*</b></label><input type="text" class="dfinput" style="width:518px;" id="phoneNumber" /></li>
						<li><label>邮箱<b>*</b></label><input type="text" class="dfinput" style="width:518px;" id="email" /></li>
						<li><label>华为云账号<b>*</b></label><input type="text" class="dfinput" style="width:518px;" id="hwcloudId" /></li>
						<li><label>备注</label><input type="text" class="dfinput" style="width:518px;" id="comment" /></li>
					</ul>
				</div>
			</div>

			<div class="tipbtn">
				<input name="" type="button" class="sure" id="sureAdd" value="确定" />&nbsp; <input
					name="" type="button" class="cancel" value="取消" />
			</div>

		</div>
		<div class="tipDelete" id="tipDelete" >
			<div class="tiptop" style="width:385px;">
				<span>信息</span><a></a>
			</div>

			<div class="tipinfo">
				<span><img src="images/ticon.png" /></span>
				<div class="tipright">
					<p>是否确认删除所选中学员 ？</p>
					<cite>如果是请点击确定按钮 ，否则请点取消。</cite>
				</div>
			</div>

			<div class="tipbtn">
				<input name="" type="button" class="sure" id="sureDelete" value="确定" />&nbsp; 
				<input name="" type="button" class="cancel" value="取消" />
			</div>
		</div>
		<div>
		<div>
			<div class="basic-grey">
				<h1>Contact Form
					<span>Please fill all the texts in the fields.</span>
				</h1>
				<label>
					<span>姓 名 :</span>
					<input id="name" type="text" name="name" placeholder="" />
				</label>
				<label>
					<span>产 品 :</span>
					<input id="tenant" type="text" name="tenant" placeholder="" />
				</label>
				
				<label>
					<span>问题描述 :</span>
					<textarea id="content" name="content" placeholder="Your Message to Us"></textarea>
				</label>
				<label>
					<span>上传照片</span>
					<table>
						<tr>
							<td>
								<form action="" method="post" id="uploadForm" enctype="multipart/form-data">
									<table border="1" cellspacing="0" cellpadding="0">
										<tr>
											<td>
												<img width="100" height="100" id="allUrl" src="images/sample.jpg"/>
											 	<input type="file" id="pic" name="file" onchange="uploadPic()" /> 
											</td>
										</tr>
									</table>
								</form>
							</td>
						</tr>
					</table>
				</label>
				<label>
					<span>&nbsp;</span>
					<input type="button" class="button"  onclick="upload()" value="提交" />
				</label>
			</div>
		</div>
	</div>
	<div id="dv"></div>
</body>

</html>
